---
params:
  population_agesex: "~/Downloads/bwa_population_stats-bw.csv"
  shape: "~/Downloads/bwa_areas_renamed.geojson"
  estimate_year: 2022
output:
  html_document:
    css: styles.css
    includes:
      in_header: header.html
    anchor_sections: no
---

---
title: `r title`
---

```{r read_outputs, echo=FALSE, message = FALSE, warning = FALSE}
#Set limit for scientific notation
options(scipen=10000000)


pop <- aggregate_pop(params$population_agesex, 
                            params$shape) %>%
  dplyr::mutate(time_to_year = abs(year - params$estimate_year)) %>%
  dplyr::filter(time_to_year == min(time_to_year)) 

shape <- sf::read_sf(params$shape) %>% sf::st_drop_geometry()

country <- shape[shape$area_level == 0, ]$area_name
pop_data_source <- unique(pop$source)
calendar_quarter <- unique(pop$calendar_quarter)

```




```{r, echo = FALSE, results = 'asis'}

cat(paste0("## ", country, " Naomi population data analysis \n"))
cat(paste0("\n### Population data source: ", calendar_quarter, " ",pop_data_source,  "\n"))
cat(paste0("\nReport generated: ", Sys.Date()))

```










```{r, echo=FALSE, warning = FALSE, message = FALSE, out.width  =  "90%", results = 'asis'}

#  Population total bar plot
remove_buttons <- c("zoomIn2d", "zoomOut2d", "pan2d", "select2d", "lasso2d",
                      "autoScale2d", "resetScale2d", "hoverClosestCartesian",
                      "hoverCompareCartesian", "zoom")


buttons <- dropdown_buttons(pop, "area_level_label")

plot_title <- paste("<b> Total population:", calendar_quarter, " ",pop_data_source, "<b>")


mrg <- list(l = 50, r = 50, b = 50, t = 120, pad = 20)

plot_data <- pop[order(pop$area_level_label), ]


plotly::plot_ly(
    data = plot_data,
    type = "bar",
    x = ~area_name,
    y = ~population,
    hoverinfo = "text",
    text = ~paste("</br>", area_name,
                  "</br>", population),
    transforms = list(
      list(
        type = "filter",
        target = ~area_level_label,
        operation = "=",
        value = sort(plot_data$area_level_label)[1]))) %>%
    plotly::layout(
      margin = mrg,
      xaxis = list(type = "category",
                   categoryarray =  ~area_name,
                   categoryorder = "array",
                   title = list(text = "")),
       yaxis = list(tickmode = "array",
                    title = list(text = "Population", font = list(size = 10))),
      title = list(text = plot_title,
                   font = list(size = 13, colour = "black", face = "bold")),
      updatemenus = list(
        list(
          type = "dropdown",
          y = 1.2,
          x  = 0.2,
          active = 0,
          buttons = buttons
        )
      )
    ) %>%
    plotly::config(modeBarButtonsToRemove = remove_buttons, displaylogo = FALSE)

  
buttons <- dropdown_buttons(plot_data, "area_level_label")

mrg <- list(l = 50, r = 50, b = 50, t = 120, pad = 20)

plot_data <- plot_data[order(plot_data$area_level), ]

plotly::plot_ly(data = plot_data,
                        type = "bar",
                        x = ~area_name,
                        y = ~population,
                        hoverinfo = "text",
                        text = ~paste("</br>", area_name,
                                      "</br>", round(population),
                        transforms = list(
                          list(
                            type = "filter",
                            target = ~area_level_label,
                            operation = "=",
                            value = sort(plot_data$area_level_label)[1])))) %>%
    plotly::layout(
      margin = mrg,
      xaxis = list(type = "category",
                   categoryarray =  ~area_name,
                   categoryorder = "array",
                   title = list(text = "")),
       yaxis = list(tickmode = "array",
                    title = list(text = "Population", font = list(size = 10))),
      title = list(text = plot_title,
                   font = list(size = 13, colour = "black", face = "bold")),
      updatemenus = list(
        list(
          type = "dropdown",
          y = 1.2,
          x  = 0.2,
          active = 0,
          buttons = buttons
        )
      )
    ) %>%
    plotly::config(modeBarButtonsToRemove = remove_buttons, displaylogo = FALSE)



```


```{r, echo=FALSE, warning = FALSE, message = FALSE, out.width  =  "90%", results = 'asis'}


survey_prev1 <- options$survey_prevalence[1]
survey_prev2 <- options$survey_prevalence[2]

#  Scatter plot survey prevalence
fig1 <-  scatter_plotly(data,
                       ind = "prevalence",
                       quarter = calendar_quarter1,
                       input_data = survey_prev1,
                       input_data_type = "survey")


#  Scatter plot survey ART coverage
fig2 <-  scatter_plotly(data,
                       ind = "art_coverage",
                       quarter = calendar_quarter1,
                       input_data = survey_art,
                       input_data_type = "survey")



if(is_empty(survey_prev2)) {

  # A single prevalence survey

  htmltools::div(
    style = "display: flex;",
    htmltools::div(fig1, style = "width: 45%;"),
    htmltools::div(fig2, style = "width: 45%"),
  )

} else {

  # Multiple prevalence surveys

  fig1B <-  scatter_plotly(data,
                       ind = "prevalence",
                       quarter = calendar_quarter1,
                       input_data = survey_prev2,
                       input_data_type = "survey")


  prev_plots <-   htmltools::div(
    style = "display: flex;",
    htmltools::div(fig1B, style = "width: 45%;"),
    htmltools::div(fig1, style = "width: 45%"),
  )

  htmltools::div(
    style = "display: flex; flex-direction: column",
    prev_plots,
    htmltools::div(fig2, style = "width: 45%")
  )
}

```

```{r, echo = FALSE, results = 'asis'}

if (print_en) {cat("\n### Age distribution \n")}
if (print_fr) {cat("\n### Age distribution \n")}
if (print_pt) {cat("\n### Age distribution \n")}

```

```{r, echo=FALSE, warning = FALSE, message = FALSE, out.width  =  "90%", results = 'asis'}


#  Barplot prevalence
fig1 <- age_bar_plotly (data,
                    ind = "prevalence",
                    quarter = calendar_quarter1)

#  Barplot ART coverage
fig2 <- age_bar_plotly (data,
                    ind = "art_coverage",
                    quarter = calendar_quarter1)

  htmltools::div(
    style = "display: flex; flex-direction: column",
    htmltools::div(fig1, style = "width: 70%"),
    htmltools::div(fig2, style = "width: 70%")
    )

```
::: {#translate lang="en"}
*Static images of individual plots can be downloaded by hovering on the right hand corner*
:::

::: {#translate lang="fr"}
*Static images of individual plots can be downloaded by hovering on the right hand corner*
:::

::: {#translate lang="pt"}
*Static images of individual plots can be downloaded by hovering on the right hand corner*
:::

```{r, echo = FALSE, results= 'asis', include = print_en, eval = print_en}
programme_data <- c(art_year, anc_prev, anc_art)

if (sum(is.na(programme_data)) <3 ) {

   cat(paste0("\n### Routinely collected programme data: \n", sep = "\n"))

   cat(paste0("For the HIV prevalence and ART coverage components of the model, ART service delivery numbers inform subnational estimates for the number of PLHIV. Since the Household survey sample size in each district is relatively small, routinely reported data about HIV prevalence among pregnant women attending their first antenatal care visit, extracted from the national health information system, are used to improve estimates of the spatial pattern of HIV. \n" , sep = "\n"))


   cat(paste0("\nThis report compares Naomi estimates to: \n", sep = "\n"))

  text2 <- tibble::tibble(prefix = c("National programme data on numbers on ART for ",
                                  "National programme data on ANC HIV prevalence for ",
                                  "National programme data on ANC ART coverage for "
                                  ),
                       source = c(art_year,
                                  anc_prev,
                                  anc_art)) %>% tidyr::drop_na()

  cat(paste0("\n ",cat(paste0("* ", text2$prefix, "_", text2$source, "_"), sep = "\n")))

 cat(paste0("The plots below compare ANC programme to age and sex matched estimates of the general population produced by Naomi. While these data should be positively correlated, we expect higher HIV prevalence and ART coverage in all females ages 15-49 relative to women attending antenatal services."  , sep = "\n"))

}


```

```{r, echo = FALSE, results= 'asis', include = print_fr, eval = print_fr}
programme_data <- c(art_year, anc_prev, anc_art)

if (sum(is.na(programme_data)) <3 ) {

  cat(paste0("\n### Données du programme opérationnel: \n", sep = "\n"))

  text2 <- tibble::tibble(prefix = c("Données national sur la couverture TARV pour ",
                                  "Données national sur la prévalence du VIH parmi CPN pour ",
                                  "Données national sur la couverture du TARV parmi CPN pour "
                                  ),
                       source = c(art_year,
                                  anc_prev,
                                  anc_art)) %>% tidyr::drop_na()

  cat(paste0("\n ",cat(paste0("* ", text2$prefix, "_", text2$source, "_"), sep = "\n")))

}

```


```{r, echo = FALSE, results= 'asis', include = print_pt, eval = print_pt}
programme_data <- c(art_year, anc_prev, anc_art)

if (sum(is.na(programme_data)) <3 ) {

  cat(paste0("\n### Dados do programa operacional: \n", sep = "\n"))

  text2 <- tibble::tibble(prefix = c("Dados do programa nacional sobre a cobertura de TARV para ",
                                  "Dados do programa nacional sobre a prevalência de VIH na CPN para ",
                                  "Dados do programa nacional sobre a cobertura de TARV na CPN para "
                                  ),
                       source = c(art_year,
                                  anc_prev,
                                  anc_art)) %>% tidyr::drop_na()

  cat(paste0("\n ",cat(paste0("* ", text2$prefix, "_", text2$source, "_"), sep = "\n")))



}

```


```{r, echo=FALSE, warning = FALSE, message = FALSE, out.width  =  "90%", results = 'asis'}

#-------------------------------------------------------------------------------
# ANC data: interactive scatter plot
#-------------------------------------------------------------------------------
anc_t1 <- outputs$fit$data_options$anc_prev_year_t1
anc_t2 <- outputs$fit$data_options$anc_prev_year_t2
has_anc <- !is_empty(anc_t1) && !is_empty(anc_t2)

if(has_anc) {
  #  Scatter plot ANC prevalence
  fig1 <-  scatter_plotly(data,
                          ind = "anc_prevalence_age_matched",
                          quarter = calendar_quarter1,
                          input_data = paste0("ANC ", anc_t1) ,
                          input_data_type = "ANC programme",
                          sex_disag = "female")

  fig2 <-  scatter_plotly(data,
                          ind = "anc_prevalence_age_matched",
                          quarter = calendar_quarter2,
                          input_data = paste0("ANC ", anc_t2) ,
                          input_data_type = "ANC programme",
                          sex_disag = "female")


  # Scatter plot ANC ART coverage

  fig3 <-  scatter_plotly(data,
                          ind = "anc_art_coverage_age_matched",
                          quarter = calendar_quarter1,
                          input_data = paste0("ANC ", anc_t2),
                          input_data_type = "ANC programme",
                          sex_disag = "female")

  fig4 <-  scatter_plotly(data,
                          ind = "anc_art_coverage_age_matched",
                          quarter = calendar_quarter2,
                          input_data = paste0("ANC ", anc_t2),
                          input_data_type = "ANC programme",
                          sex_disag = "female")


  prev_plots <-   htmltools::div(
    style = "display: flex;",
    htmltools::div(fig1, style = "width: 40%;"),
    htmltools::div(fig2, style = "width: 40%;")
  )

  art_plots <-   htmltools::div(
    style = "display: flex;",
    htmltools::div(fig3, style = "width: 40%;"),
    htmltools::div(fig4, style = "width: 40%;")
  )

  htmltools::div(
    style = "display: flex; flex-direction: column",
    prev_plots,
    art_plots
  )
}
```




::: {#translate lang="en"}
_Version_

The Naomi model is supported by [UNAIDS](https://www.unaids.org/en) and developed and maintained by the [MRC Centre for Global Infectious Disease Analysis](https://www.imperial.ac.uk/mrc-global-infectious-disease-analysis) at Imperial College London. The model receives technical guidance from the [UNAIDS Reference Group on Estimates, Modelling, and Projections](http://epidem.org/). The model was first used in 2020 and continues to be developed responsive to new data and HIV strategic information needs.
:::
