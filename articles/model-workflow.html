<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Naomi Model Workflow Example • naomi</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Naomi Model Workflow Example">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">naomi</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.3</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/data-model.html">Naomi data model</a>
    </li>
    <li>
      <a href="../articles/model-workflow.html">Naomi Model Workflow Example</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Naomi Model Workflow Example</h1>
            
      
      
      <div class="hidden name"><code>model-workflow.Rmd</code></div>

    </div>

    
    
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(naomi)
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(tidyverse)
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(sf)</code></pre></div>
<div id="prepare-webtool-geojson-input" class="section level1">
<h1 class="hasAnchor">
<a href="#prepare-webtool-geojson-input" class="anchor"></a>0. Prepare webtool GeoJSON input</h1>
<p>The MVP version of Naomi web tool allows upload of a single GeoJSON file for specifying the area hierarchy. This preprocessing step joins the area tables into a single long format dataset and saves as a GeoJSON for upload to the web tool.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">
area_levels &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="kw"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span>(<span class="st">"extdata/areas/area_levels.csv"</span>, <span class="dt">package =</span> <span class="st">"naomi"</span>))
area_hierarchy  &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="kw"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span>(<span class="st">"extdata/areas/area_hierarchy.csv"</span>, <span class="dt">package =</span> <span class="st">"naomi"</span>))
area_boundaries &lt;-<span class="st"> </span>sf<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/sf/man/st_read.html">read_sf</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span>(<span class="st">"extdata/areas/area_boundaries.geojson"</span>, <span class="dt">package =</span> <span class="st">"naomi"</span>))

area_long &lt;-<span class="st"> </span>area_hierarchy <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">left_join</span>(
    area_levels <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(area_level, area_level_label, display, naomi_level)
  ) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">left_join</span>(
    area_boundaries
  )</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://rdrr.io/pkg/sf/man/st_write.html">st_write</a></span>(area_long, <span class="kw"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/tempfile.html">tempdir</a></span>(), <span class="st">"area_long.geojson"</span>), <span class="dt">delete_dsn =</span> <span class="ot">TRUE</span>)
<span class="co">#&gt; Deleting source `/tmp/RtmpeqMYnh/area_long.geojson' failed</span>
<span class="co">#&gt; Writing layer `area_long' to data source `/tmp/RtmpeqMYnh/area_long.geojson' using driver `GeoJSON'</span>
<span class="co">#&gt; Writing 69 features with 10 fields and geometry type Multi Polygon.</span></code></pre></div>
</div>
<div id="upload-data-inputs" class="section level1">
<h1 class="hasAnchor">
<a href="#upload-data-inputs" class="anchor"></a>1. (Up)Load data inputs</h1>
<p>Area hierarchy and boundaries</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">area_long &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/pkg/sf/man/st_read.html">read_sf</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/tempfile.html">tempdir</a></span>(), <span class="st">"area_long.geojson"</span>))

areas &lt;-<span class="st"> </span><span class="kw"><a href="../reference/create_areas.html">create_areas</a></span>(area_levels, area_hierarchy, area_boundaries)</code></pre></div>
<p>Population data</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">pop_agesex &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="kw"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span>(<span class="st">"extdata/population/population_agesex.csv"</span>, <span class="dt">package =</span> <span class="st">"naomi"</span>))</code></pre></div>
<p>Survey data</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">survey_hiv_indicators &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="kw"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span>(<span class="st">"extdata/survey/survey_hiv_indicators.csv"</span>, <span class="dt">package =</span> <span class="st">"naomi"</span>))</code></pre></div>
<p>Programme data</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">art_number &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="kw"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span>(<span class="st">"extdata/programme/art_number.csv"</span>, <span class="dt">package =</span> <span class="st">"naomi"</span>))
anc_testing &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="kw"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span>(<span class="st">"extdata/programme/anc_testing.csv"</span>, <span class="dt">package =</span> <span class="st">"naomi"</span>))</code></pre></div>
<p>Programme data</p>
<p>Spectrum PJNZ</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">pjnz &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span>(<span class="st">"extdata/mwi2019.PJNZ"</span>, <span class="dt">package =</span> <span class="st">"naomi"</span>)
spec &lt;-<span class="st"> </span><span class="kw"><a href="../reference/extract_pjnz_naomi.html">extract_pjnz_naomi</a></span>(pjnz)</code></pre></div>
</div>
<div id="choose-model-areas-and-time-points" class="section level1">
<h1 class="hasAnchor">
<a href="#choose-model-areas-and-time-points" class="anchor"></a>2. Choose model areas and time points</h1>
<p>The following are required to be provided to define the model state space:</p>
<ul>
<li>
<code>scope</code>: A collection of <code>area_id</code>s defining the set of areas to be modelled. Usually this is simply national level, so the level 0 <code>area_id</code>.</li>
<li>
<code>level</code>: Area level at which to fit model.</li>
<li>
<code>quarter_id_t1</code>: The first time point for the model–approximately the midpoint of the household survey data used.</li>
<li>
<code>quarter_id_t2</code>: The second time point for the model–the current time for which estimates are needed.</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">scope &lt;-<span class="st"> "MWI"</span>
level &lt;-<span class="st"> </span><span class="dv">4</span>
quarter_id_t1 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/quarter_year_labels.html">convert_quarter_id</a></span>(<span class="dv">1</span>, <span class="dv">2016</span>)
quarter_id_t2 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/quarter_year_labels.html">convert_quarter_id</a></span>(<span class="dv">3</span>, <span class="dv">2018</span>)</code></pre></div>
<p>The following select data inputs to model fitting from the uploaded datasets. Providing <code>NULL</code> for any will exclude that data source from model fitting.</p>
<ul>
<li>Multiple household survey may be used in fitting, but they must be rougly contemporaneous around <code>quarter_id_t1</code>.</li>
<li>Only survey ART coverage or survey VLS should be included from a given survey, not both. ART coverage is preferred if both are available.</li>
<li>
<code>artnum_quarter_id_t1</code> and <code>artnum_quarter_id_t1</code> are the time point at which current on ART programme data will be used to estimte ART coverage. They are typically the same <code>quarter_id_t1</code> and <code>quarter_id_t2</code> if ART programme data are used.</li>
<li>
<code>anc_quarter_id_t1</code> and <code>anc_quarter_id_t2</code> are typically a range of 3-4 quarters. Data will be aggregated over these quarters for a larger sample size. They will typically be consecutive quarters, though a quarter could be dropped for example if there were reporting problems known to affect a given quarter. Survey IDs to include in fitting</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">prev_survey_ids  &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"MWI2016PHIA"</span>, <span class="st">"MWI2015DHS"</span>)
artcov_survey_ids  &lt;-<span class="st"> "MWI2016PHIA"</span>
vls_survey_ids &lt;-<span class="st"> </span><span class="ot">NULL</span>
recent_survey_ids &lt;-<span class="st"> "MWI2016PHIA"</span>

artnum_quarter_id_t1 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/quarter_year_labels.html">convert_quarter_id</a></span>(<span class="dv">1</span>, <span class="dv">2016</span>)
artnum_quarter_id_t2 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/quarter_year_labels.html">convert_quarter_id</a></span>(<span class="dv">3</span>, <span class="dv">2018</span>)

anc_quarter_id_t1 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/quarter_year_labels.html">convert_quarter_id</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">4</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>), <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">2015</span>, <span class="dv">2016</span>, <span class="dv">2016</span>, <span class="dv">2016</span>))
anc_quarter_id_t2 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/quarter_year_labels.html">convert_quarter_id</a></span>(<span class="dv">1</span><span class="op">:</span><span class="dv">4</span>, <span class="dv">2018</span>)</code></pre></div>
</div>
<div id="review-input-data" class="section level1">
<h1 class="hasAnchor">
<a href="#review-input-data" class="anchor"></a>3. Review input data</h1>
</div>
<div id="prepare-model-inputs" class="section level1">
<h1 class="hasAnchor">
<a href="#prepare-model-inputs" class="anchor"></a>4. Prepare model inputs</h1>
<p>Setup the model</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">naomi_mf &lt;-<span class="st"> </span><span class="kw"><a href="../reference/naomi_model_frame.html">naomi_model_frame</a></span>(areas,
                              pop_agesex,
                              spec,
                              <span class="dt">scope =</span> scope,
                              <span class="dt">level =</span> level,
                              quarter_id_t1,
                              quarter_id_t2)</code></pre></div>
<p>Prepare data inputs</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">prev_dat &lt;-<span class="st"> </span><span class="kw"><a href="../reference/survey_prevalence_mf.html">survey_prevalence_mf</a></span>(prev_survey_ids, survey_hiv_indicators, naomi_mf)
artcov_dat &lt;-<span class="st"> </span><span class="kw"><a href="../reference/survey_prevalence_mf.html">survey_artcov_mf</a></span>(artcov_survey_ids, survey_hiv_indicators, naomi_mf)
recent_dat &lt;-<span class="st"> </span><span class="kw"><a href="../reference/survey_prevalence_mf.html">survey_recent_mf</a></span>(recent_survey_ids, survey_hiv_indicators, naomi_mf)
<span class="co">#&gt; Joining, by = "age_group_id"</span>

anc_prev_t1_dat &lt;-<span class="st"> </span><span class="kw"><a href="../reference/anc_testing_prev_mf.html">anc_testing_prev_mf</a></span>(anc_quarter_id_t1, anc_testing, naomi_mf)
anc_artcov_t1_dat &lt;-<span class="st"> </span><span class="kw"><a href="../reference/anc_testing_prev_mf.html">anc_testing_artcov_mf</a></span>(anc_quarter_id_t1, anc_testing, naomi_mf)

anc_prev_t2_dat &lt;-<span class="st"> </span><span class="kw"><a href="../reference/anc_testing_prev_mf.html">anc_testing_prev_mf</a></span>(anc_quarter_id_t2, anc_testing, naomi_mf)
anc_artcov_t2_dat &lt;-<span class="st"> </span><span class="kw"><a href="../reference/anc_testing_prev_mf.html">anc_testing_artcov_mf</a></span>(anc_quarter_id_t2, anc_testing, naomi_mf)

artnum_t1_dat &lt;-<span class="st"> </span><span class="kw"><a href="../reference/anc_testing_prev_mf.html">artnum_mf</a></span>(artnum_quarter_id_t1, art_number, naomi_mf)
artnum_t2_dat &lt;-<span class="st"> </span><span class="kw"><a href="../reference/anc_testing_prev_mf.html">artnum_mf</a></span>(artnum_quarter_id_t2, art_number, naomi_mf)</code></pre></div>
<ol start="5" style="list-style-type: decimal">
<li>Fit model Prepare model inputs and initial parameters</li>
</ol>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">tmb_inputs &lt;-<span class="st"> </span><span class="kw"><a href="../reference/prepare_tmb_inputs.html">prepare_tmb_inputs</a></span>(naomi_mf, prev_dat, artcov_dat, recent_dat,
                                 anc_prev_t1_dat,
                                 anc_prev_t2_dat,
                                 anc_artcov_t1_dat,
                                 anc_artcov_t2_dat,
                                 artnum_t1_dat,
                                 artnum_t2_dat)</code></pre></div>
<p>Fit the TMB model</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fit &lt;-<span class="st"> </span><span class="kw"><a href="../reference/fit_tmb.html">fit_tmb</a></span>(tmb_inputs)
<span class="co">#&gt;   0:     819343.98:  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000  0.00000</span>
<span class="co">#&gt;   1:     819267.00: 0.147193 -1.61930 0.163542 -1.88396 0.203892 -0.543050 0.0548338 -0.848243 0.114778 -1.22929 0.121159 -1.47212 0.204682 0.0288302 0.0573018 -0.708658 -0.000134455 7.90430e-05 -0.300419 -1.64343 -1.29447</span>
<span class="co">#&gt;   2:     819235.50: 0.0816504 0.0552678 0.339785 -3.96829 0.671900 -0.924206 0.183563 -1.85982 0.133508 -1.32305 0.224128 -2.79820 0.492465 0.0995459 0.180450 -1.48606 -0.000308742 0.000195590 -0.646270 0.514978 -0.909901</span>
<span class="co">#&gt;   3:     819194.13: 0.168808 -0.709132 0.351823 -4.16044  1.22685 -0.308707 0.289045 -2.19939 0.0733740 -0.465795 0.236212 -2.95481 0.641783 0.0667734 0.289208 -1.57152 -0.000381011 0.000270100 -0.728612 -0.284051 -0.577144</span>
<span class="co">#&gt;   4:     819180.76: 0.201425 -0.988619 0.349411 -4.14875  1.35001 -0.481570 0.325083 -2.26376 0.100902 -0.774999 0.236616 -2.97124 0.684936 0.00770694 0.330372 -1.59888 -0.000404221 0.000295042 -0.745954 -0.788203 -0.670022</span>
<span class="co">#&gt;   5:     819178.90: 0.213178 -0.932734 0.345908 -4.13182  1.53400 -0.633204 0.379992 -2.33953 0.107611 -0.861817 0.237566 -2.99678 0.740732 -0.0112113 0.390975 -1.64055 -0.000437682 0.000330129 -0.769952 -0.973494 -0.721844</span>
<span class="co">#&gt;   6:     819177.97: 0.236645 -1.00438 0.341675 -4.11206  1.73101 -0.657421 0.445608 -2.40401 0.103449 -0.831241 0.238690 -3.02469 0.797269 0.00239415 0.460884 -1.68742 -0.000475241 0.000367922 -0.795358 -0.735089 -0.706550</span>
<span class="co">#&gt;   7:     819176.16: 0.254168 -0.942809 0.335652 -4.08326  1.95342 -0.630539 0.536176 -2.46160 0.107346 -0.907156 0.239633 -3.05553 0.866381 0.0128852 0.556109 -1.74443 -0.000524555 0.000414885 -0.825752 -0.914641 -0.716639</span>
<span class="co">#&gt;   8:     819175.58: 0.281223 -0.987331 0.329085 -4.05645  2.16139 -0.593156 0.636673 -2.51078 0.0910831 -0.749701 0.240828 -3.08969 0.934290 0.0208644 0.660342 -1.78777 -0.000576735 0.000460605 -0.855838 -0.782393 -0.751147</span>
<span class="co">#&gt;   9:     819174.43: 0.307553 -0.961683 0.320403 -4.02641  2.34609 -0.512513 0.769221 -2.53170 0.0976606 -0.873768 0.241820 -3.12436  1.00457 0.0223467 0.796140 -1.82595 -0.000641210 0.000508743 -0.887714 -0.830520 -0.616599</span>
<span class="co">#&gt;  10:     819173.93: 0.313324 -0.948055 0.318159 -4.01886  2.39925 -0.517574 0.801311 -2.53987 0.0930460 -0.823937 0.241898 -3.13277  1.01917 0.0296149 0.829450 -1.83155 -0.000656649 0.000519165 -0.895013 -0.903811 -0.729312</span>
<span class="co">#&gt;  11:     819173.63: 0.327607 -0.963583 0.313756 -4.00437  2.48871 -0.501159 0.862602 -2.55115 0.0955916 -0.872665 0.242112 -3.14579  1.04655 0.0395833 0.892868 -1.84196 -0.000685739 0.000538072 -0.908387 -0.850142 -0.675274</span>
<span class="co">#&gt;  12:     819172.96: 0.356612 -0.924800 0.300656 -3.97085  2.61473 -0.401282  1.03875 -2.51809 0.0922724 -0.892954 0.241650 -3.17176  1.09900 0.0544226  1.07426 -1.83494 -0.000762653 0.000572333 -0.934675 -0.870817 -0.750135</span>
<span class="co">#&gt;  13:     819172.81: 0.384903 -1.01282 0.291285 -3.94924  2.78547 -0.495548  1.15900 -2.52009 0.0777016 -0.776832 0.241725 -3.18957  1.13876 0.0707668  1.19960 -1.82505 -0.000815254 0.000595757 -0.953719 -0.914738 -0.651166</span>
<span class="co">#&gt;  14:     819172.09: 0.401045 -0.888500 0.277246 -3.92846  2.85170 -0.385684  1.33238 -2.47541 0.0733085 -0.794096 0.240694 -3.20596  1.17990 0.0569992  1.38176 -1.78701 -0.000885240 0.000610129 -0.971255 -0.894629 -0.703064</span>
<span class="co">#&gt;  15:     819171.89: 0.437898 -1.00047 0.262524 -3.90829  2.93176 -0.349638  1.48642 -2.44113 0.0795569 -0.929855 0.238853 -3.21318  1.20247 0.0922252  1.55533 -1.75726 -0.000947434 0.000618453 -0.985730 -0.890324 -0.785024</span>
<span class="co">#&gt;  16:     819171.28: 0.457059 -0.960388 0.244606 -3.89660  3.02563 -0.301911  1.65994 -2.38273 0.0646232 -0.856644 0.237084 -3.22092  1.22304 0.133293  1.75961 -1.71185 -0.00101640 0.000621037 -0.999406 -0.877991 -0.704836</span>
<span class="co">#&gt;  17:     819171.20: 0.455513 -0.923039 0.242565 -3.89482  3.04860 -0.295580  1.67611 -2.38258 0.0631139 -0.847415 0.236883 -3.22213  1.23979 0.0935988  1.77857 -1.70572 -0.00102272 0.000622479 -1.00123 -0.889908 -0.717797</span>
<span class="co">#&gt;  18:     819171.16: 0.462253 -0.965242 0.239559 -3.89216  3.07920 -0.282495  1.69852 -2.38042 0.0628328 -0.856297 0.236599 -3.22348  1.24733 0.0893868  1.80655 -1.69960 -0.00103163 0.000624381 -1.00372 -0.874079 -0.703664</span>
<span class="co">#&gt;  19:     819171.08: 0.462776 -0.933681 0.235684 -3.89020  3.10708 -0.275572  1.72882 -2.36928 0.0604971 -0.847173 0.236145 -3.22465  1.25106 0.0936729  1.84422 -1.68851 -0.00104313 0.000624820 -1.00586 -0.889597 -0.713508</span>
<span class="co">#&gt;  20:     819170.97: 0.472705 -0.958774 0.226444 -3.88564  3.17246 -0.245431  1.79587 -2.34632 0.0577025 -0.855623 0.235077 -3.22696  1.26180 0.0974881  1.92976 -1.66430 -0.00106842 0.000626091 -1.01083 -0.871613 -0.706376</span>
<span class="co">#&gt;  21:     819170.61: 0.516477 -0.971217 0.162680 -3.87716  3.46803 -0.193130  2.23738 -2.13737 0.0294396 -0.843308 0.226667 -3.23000  1.29997 0.107335  2.49425 -1.46685 -0.00121980 0.000612688 -1.02951 -0.916225 -0.704048</span>
<span class="co">#&gt;  22:     819170.45: 0.532051 -0.939085 0.0856374 -3.89259  3.71072 0.0122097  2.67688 -2.10032 -0.00722878 -0.787516 0.215494 -3.21526  1.33800 0.0452013  3.05736 -1.21195 -0.00132242 0.000588244 -1.03787 -0.869816 -0.709127</span>
<span class="co">#&gt;  23:     819170.36: 0.524481 -0.919070 0.0573304 -3.89641  3.82339 0.0782343  2.75151 -2.00002 -0.00775759 -0.904305 0.211326 -3.21187  1.28879 0.162062  3.25435 -1.17975 -0.00132585 0.000590336 -1.03676 -0.899417 -0.695927</span>
<span class="co">#&gt;  24:     819170.22: 0.522931 -0.935420 0.0546247 -3.89605  3.85102 0.0635752  2.73507 -1.95746 -0.0124375 -0.850228 0.211197 -3.21635  1.30016 0.113309  3.26694 -1.18181 -0.00131442 0.000596099 -1.03594 -0.871365 -0.727898</span>
<span class="co">#&gt;  25:     819170.21: 0.521842 -0.931893 0.0541678 -3.89555  3.85456 0.0606809  2.73602 -1.95977 -0.0116503 -0.861187 0.211181 -3.21662  1.30233 0.102911  3.26568 -1.17566 -0.00131146 0.000597304 -1.03569 -0.890813 -0.705557</span>
<span class="co">#&gt;  26:     819170.20: 0.518753 -0.934236 0.0505434 -3.89342  3.86760 0.0643263  2.74352 -1.96158 -0.0127021 -0.855440 0.210824 -3.21942  1.29659 0.0990876  3.27175 -1.14896 -0.00129724 0.000602964 -1.03445 -0.883838 -0.710656</span>
<span class="co">#&gt;  27:     819170.20: 0.515493 -0.933939 0.0454987 -3.89124  3.88156 0.0761824  2.74902 -1.94984 -0.0138078 -0.854008 0.210241 -3.22204  1.29052 0.0966501  3.29378 -1.13865 -0.00128202 0.000608390 -1.03350 -0.885030 -0.711080</span>
<span class="co">#&gt;  28:     819170.19: 0.503230 -0.932385 0.0274468 -3.88655  3.94026 0.103906  2.78024 -1.94481 -0.0164123 -0.855697 0.207728 -3.22383  1.26330 0.0950667  3.36811 -1.10299 -0.00122879 0.000615863 -1.02834 -0.887940 -0.711367</span>
<span class="co">#&gt;  29:     819170.19: 0.492925 -0.932042 0.00715141 -3.88484  3.99827 0.126484  2.80074 -1.92639 -0.0190617 -0.856387 0.204691 -3.22329  1.24495 0.0771847  3.44963 -1.07515 -0.00117705 0.000619535 -1.02467 -0.881366 -0.709102</span>
<span class="co">#&gt;  30:     819170.19: 0.504269 -0.938221 -0.00325836 -3.88452  4.00050 0.130080  2.79952 -1.92818 -0.0194727 -0.853009 0.203119 -3.22711  1.26456 0.0851489  3.47404 -1.05255 -0.00118514 0.000627300 -1.03459 -0.887072 -0.709609</span>
<span class="co">#&gt;  31:     819170.19: 0.507072 -0.935370 -0.00253677 -3.88860  3.99738 0.126083  2.78211 -1.93070 -0.0174578 -0.855671 0.202981 -3.22547  1.27125 0.0937624  3.46221 -1.05540 -0.00121306 0.000610145 -1.03143 -0.883952 -0.711396</span>
<span class="co">#&gt;  32:     819170.19: 0.504817 -0.935187 -0.00441364 -3.88706  3.99061 0.125018  2.78078 -1.94247 -0.0169422 -0.854321 0.202514 -3.22440  1.26704 0.0887600  3.46968 -1.06504 -0.00121781 0.000610927 -1.02801 -0.884284 -0.710682</span>
<span class="co">#&gt;  33:     819170.19: 0.503274 -0.935498 -0.00718231 -3.88549  3.99287 0.125364  2.77283 -1.94049 -0.0164128 -0.855125 0.202123 -3.22654  1.26364 0.0852205  3.46978 -1.05398 -0.00120694 0.000626963 -1.03137 -0.885998 -0.708850</span>
<span class="co">#&gt;  34:     819170.19: 0.504290 -0.936253 -0.00931705 -3.88632  3.99439 0.125702  2.76943 -1.94120 -0.0162219 -0.854283 0.201689 -3.22597  1.26486 0.0879680  3.47577 -1.05449 -0.00120468 0.000620737 -1.03227 -0.885163 -0.710375</span>
<span class="co">#&gt;  35:     819170.19: 0.504889 -0.935630 -0.0103469 -3.88722  3.99222 0.125180  2.76522 -1.94456 -0.0157680 -0.854604 0.201404 -3.22528  1.26673 0.0884696  3.47676 -1.05463 -0.00120978 0.000613674 -1.03028 -0.884891 -0.710244</span></code></pre></div>
<p>Calculate model outputs. We can calculate outputs based on posterior mode estimates before running <code><a href="../reference/report_tmb.html">report_tmb()</a></code> to calculate posterior intervals.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">outputs &lt;-<span class="st"> </span><span class="kw"><a href="../reference/output_package.html">output_package</a></span>(fit, naomi_mf, areas)</code></pre></div>
<p>The output package consists of a data frame of indicators and metadata defining the labels for each indicator.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://rdrr.io/r/base/names.html">names</a></span>(outputs)
<span class="co">#&gt; [1] "indicators"     "meta_area"      "meta_age_group" "meta_period"   </span>
<span class="co">#&gt; [5] "meta_indicator"</span></code></pre></div>
<p>If uncertainty has not been calcualted yet, the output object retures values for <code>mode</code>, but not <code>mean</code> or <code>lower</code> and <code>upper</code> 95% uncertainty ranges.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">outputs<span class="op">$</span>indicators <span class="op">%&gt;%</span>
<span class="st">  </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(
    indicator_id <span class="op">==</span><span class="st"> </span>2L,  <span class="co"># HIV prevalence</span>
    age_group_id <span class="op">==</span><span class="st"> </span><span class="dv">18</span>   <span class="co"># Age group 15-49</span>
  ) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="https://rdrr.io/r/utils/head.html">head</a></span>()
<span class="co">#&gt; # A tibble: 6 x 11</span>
<span class="co">#&gt;   area_id sex   age_group_id quarter_id indicator_id   mode  mean    se</span>
<span class="co">#&gt;   &lt;chr&gt;   &lt;chr&gt;        &lt;int&gt;      &lt;int&gt;        &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span>
<span class="co">#&gt; 1 MWI     both            18        465            2 0.0959    NA    NA</span>
<span class="co">#&gt; 2 MWI     fema…           18        465            2 0.103     NA    NA</span>
<span class="co">#&gt; 3 MWI     male            18        465            2 0.0886    NA    NA</span>
<span class="co">#&gt; 4 MWI.1   both            18        465            2 0.0663    NA    NA</span>
<span class="co">#&gt; 5 MWI.1   fema…           18        465            2 0.0711    NA    NA</span>
<span class="co">#&gt; 6 MWI.1   male            18        465            2 0.0613    NA    NA</span>
<span class="co">#&gt; # … with 3 more variables: median &lt;dbl&gt;, lower &lt;dbl&gt;, upper &lt;dbl&gt;</span></code></pre></div>
<p>The function <code><a href="../reference/add_output_labels.html">add_output_labels()</a></code> returns the indicators table with labels added as additional columns.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/add_output_labels.html">add_output_labels</a></span>(outputs) <span class="op">%&gt;%</span>
<span class="st">  </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(
    indicator_id <span class="op">==</span><span class="st"> </span>2L,  <span class="co"># HIV prevalence</span>
    age_group_id <span class="op">==</span><span class="st"> </span><span class="dv">18</span>   <span class="co"># Age group 15-49</span>
  ) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="https://rdrr.io/r/utils/head.html">head</a></span>()
<span class="co">#&gt; # A tibble: 6 x 17</span>
<span class="co">#&gt;   area_level area_level_label area_id area_name sex   age_group_id</span>
<span class="co">#&gt;        &lt;dbl&gt; &lt;chr&gt;            &lt;chr&gt;   &lt;chr&gt;     &lt;chr&gt;        &lt;int&gt;</span>
<span class="co">#&gt; 1          0 Country          MWI     Malawi    both            18</span>
<span class="co">#&gt; 2          0 Country          MWI     Malawi    fema…           18</span>
<span class="co">#&gt; 3          0 Country          MWI     Malawi    male            18</span>
<span class="co">#&gt; 4          1 Region           MWI.1   Northern  both            18</span>
<span class="co">#&gt; 5          1 Region           MWI.1   Northern  fema…           18</span>
<span class="co">#&gt; 6          1 Region           MWI.1   Northern  male            18</span>
<span class="co">#&gt; # … with 11 more variables: age_group_label &lt;chr&gt;, quarter_id &lt;int&gt;,</span>
<span class="co">#&gt; #   quarter_label &lt;chr&gt;, indicator_id &lt;dbl&gt;, indicator_label &lt;chr&gt;,</span>
<span class="co">#&gt; #   mode &lt;dbl&gt;, mean &lt;dbl&gt;, se &lt;dbl&gt;, median &lt;dbl&gt;, lower &lt;dbl&gt;,</span>
<span class="co">#&gt; #   upper &lt;dbl&gt;</span></code></pre></div>
<p>Calculate uncertainty ranges and add to the output object (This is time consuming and memory intensive.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span>(fit &lt;-<span class="st"> </span><span class="kw"><a href="../reference/sample_tmb.html">sample_tmb</a></span>(fit))
<span class="co">#&gt; [1] "Simulating outputs"</span>
<span class="co">#&gt; [1] "Returning sample"</span>
<span class="co">#&gt;    user  system elapsed </span>
<span class="co">#&gt;  73.015   0.168  73.196</span></code></pre></div>
<p>Regenerate outputs with uncertainty ranges.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span>(outputs &lt;-<span class="st"> </span><span class="kw"><a href="../reference/output_package.html">output_package</a></span>(fit, naomi_mf, areas))
<span class="co">#&gt;    user  system elapsed </span>
<span class="co">#&gt;   4.509   0.036   4.545</span>

outputs<span class="op">$</span>indicators <span class="op">%&gt;%</span>
<span class="st">  </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(
    indicator_id <span class="op">==</span><span class="st"> </span>2L,  <span class="co"># HIV prevalence</span>
    age_group_id <span class="op">==</span><span class="st"> </span><span class="dv">18</span>   <span class="co"># Age group 15-49</span>
  ) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="https://rdrr.io/r/utils/head.html">head</a></span>()
<span class="co">#&gt; # A tibble: 6 x 11</span>
<span class="co">#&gt;   area_id sex   age_group_id quarter_id indicator_id   mode   mean      se</span>
<span class="co">#&gt;   &lt;chr&gt;   &lt;chr&gt;        &lt;int&gt;      &lt;int&gt;        &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;</span>
<span class="co">#&gt; 1 MWI     both            18        465            2 0.0959 0.0960 0.00119</span>
<span class="co">#&gt; 2 MWI     fema…           18        465            2 0.103  0.103  0.00168</span>
<span class="co">#&gt; 3 MWI     male            18        465            2 0.0886 0.0887 0.00163</span>
<span class="co">#&gt; 4 MWI.1   both            18        465            2 0.0663 0.0665 0.00121</span>
<span class="co">#&gt; 5 MWI.1   fema…           18        465            2 0.0711 0.0712 0.00161</span>
<span class="co">#&gt; 6 MWI.1   male            18        465            2 0.0613 0.0615 0.00147</span>
<span class="co">#&gt; # … with 3 more variables: median &lt;dbl&gt;, lower &lt;dbl&gt;, upper &lt;dbl&gt;</span></code></pre></div>
<p>Save model outputs to ZIP</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://rdrr.io/r/base/files2.html">dir.create</a></span>(<span class="st">"outputs"</span>, <span class="dt">showWarnings =</span> <span class="ot">FALSE</span>)
<span class="kw"><a href="../reference/save_output_package.html">save_output_package</a></span>(outputs, <span class="st">"mwi_outputs"</span>, <span class="st">"outputs"</span>, <span class="dt">with_labels =</span> <span class="ot">FALSE</span>)
<span class="kw"><a href="../reference/save_output_package.html">save_output_package</a></span>(outputs, <span class="st">"mwi_outputs_with_labels"</span>, <span class="st">"outputs"</span>, <span class="dt">with_labels =</span> <span class="ot">TRUE</span>)
<span class="kw"><a href="../reference/save_output_package.html">save_output_package</a></span>(outputs, <span class="st">"mwi_outputs_single_csv"</span>, <span class="st">"outputs"</span>, <span class="dt">with_labels =</span> <span class="ot">TRUE</span>, <span class="dt">single_csv =</span> <span class="ot">TRUE</span>)
<span class="kw"><a href="../reference/save_output_package.html">save_output_package</a></span>(outputs, <span class="st">"mwi_outputs_single_csv_unlabelled"</span>, <span class="st">"outputs"</span>, <span class="dt">with_labels =</span> <span class="ot">FALSE</span>, <span class="dt">single_csv =</span> <span class="ot">TRUE</span>)


## #' 6. Plot some model outputs

indicators &lt;-<span class="st"> </span><span class="kw"><a href="../reference/add_output_labels.html">add_output_labels</a></span>(outputs) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">left_join</span>(outputs<span class="op">$</span>meta_area <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(area_level, area_id, center_x, center_y)) <span class="op">%&gt;%</span>
<span class="st">  </span>sf<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/sf/man/st_as_sf.html">st_as_sf</a></span>()</code></pre></div>
<p>15-49 prevalence by district</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">indicators <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(age_group_id <span class="op">==</span><span class="st"> </span><span class="dv">18</span>,
         indicator_id <span class="op">==</span><span class="st"> </span>2L,
         area_level <span class="op">==</span><span class="st"> </span><span class="dv">4</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">fill =</span> mode)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_sf</span>() <span class="op">+</span>
<span class="st">  </span>viridis<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/viridis/man/scale_viridis.html">scale_fill_viridis</a></span>(<span class="dt">labels =</span> scales<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/scales/man/number_format.html">percent_format</a></span>()) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="../reference/th_map.html">th_map</a></span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>sex)</code></pre></div>
<div class="figure">
<img src="figure/unnamed-chunk-15-1.png" alt="plot of chunk unnamed-chunk-15"><p class="caption">plot of chunk unnamed-chunk-15</p>
</div>
<p>15-49 prevalence by Zone</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">indicators <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(age_group_id <span class="op">==</span><span class="st"> </span><span class="dv">18</span>,
         ## sex == "both",
         indicator_id <span class="op">==</span><span class="st"> </span>2L,
         area_level <span class="op">==</span><span class="st"> </span><span class="dv">2</span>) <span class="op">%&gt;%</span>
<span class="st">  </span>## semi_join(get_area_collection(areas, level = 3, area_scope = "MWI.3")) %&gt;%
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">fill =</span> mean)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_sf</span>() <span class="op">+</span>
<span class="st">  </span>viridis<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/viridis/man/scale_viridis.html">scale_fill_viridis</a></span>(<span class="dt">labels =</span> scales<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/scales/man/number_format.html">percent_format</a></span>()) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="../reference/th_map.html">th_map</a></span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>sex)</code></pre></div>
<div class="figure">
<img src="figure/unnamed-chunk-16-1.png" alt="plot of chunk unnamed-chunk-16"><p class="caption">plot of chunk unnamed-chunk-16</p>
</div>
<p>Age-specific prevalence, national</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">indicators <span class="op">%&gt;%</span>
<span class="st">  </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(area_level <span class="op">==</span><span class="st"> </span><span class="dv">0</span>,
         sex <span class="op">!=</span><span class="st"> "both"</span>,
         age_group_id <span class="op">%in%</span><span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="dv">17</span>,
         indicator_id <span class="op">==</span><span class="st"> </span>2L) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">left_join</span>(<span class="kw"><a href="../reference/get_age_groups.html">get_age_groups</a></span>()) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">age_group =</span> <span class="kw">fct_reorder</span>(age_group_label, age_group_id)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(age_group, mean, <span class="dt">ymin =</span> lower, <span class="dt">ymax =</span> upper, <span class="dt">fill =</span> sex)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_col</span>(<span class="dt">position =</span> <span class="st">"dodge"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_linerange</span>(<span class="dt">position =</span> <span class="kw">position_dodge</span>(<span class="fl">0.8</span>)) <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_fill_brewer</span>(<span class="dt">palette =</span> <span class="st">"Set1"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">labels =</span> scales<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/scales/man/number_format.html">percent_format</a></span>(<span class="dv">1</span>)) <span class="op">+</span>
<span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>area_name) <span class="op">+</span>
<span class="st">  </span><span class="kw">theme</span>(<span class="dt">axis.text.x =</span> <span class="kw">element_text</span>(<span class="dt">angle =</span> <span class="dv">90</span>, <span class="dt">hjust =</span> <span class="fl">1.0</span>, <span class="dt">vjust =</span> <span class="fl">0.5</span>))
<span class="co">#&gt; Joining, by = c("age_group_id", "age_group_label")</span></code></pre></div>
<div class="figure">
<img src="figure/unnamed-chunk-17-1.png" alt="plot of chunk unnamed-chunk-17"><p class="caption">plot of chunk unnamed-chunk-17</p>
</div>
<p>15-64 ART coverage by district</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">indicators <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(age_group_id <span class="op">==</span><span class="st"> </span><span class="dv">19</span>,
         area_level <span class="op">==</span><span class="st"> </span><span class="dv">4</span>,
         indicator_id <span class="op">==</span><span class="st"> </span>4L) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">fill =</span> mean)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_sf</span>() <span class="op">+</span>
<span class="st">  </span>viridis<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/viridis/man/scale_viridis.html">scale_fill_viridis</a></span>(<span class="dt">labels =</span> scales<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/scales/man/number_format.html">percent_format</a></span>()) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="../reference/th_map.html">th_map</a></span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>sex)</code></pre></div>
<div class="figure">
<img src="figure/unnamed-chunk-18-1.png" alt="plot of chunk unnamed-chunk-18"><p class="caption">plot of chunk unnamed-chunk-18</p>
</div>
<p>Age-specific ART coverage, national</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">indicators <span class="op">%&gt;%</span>
<span class="st">  </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(area_level <span class="op">==</span><span class="st"> </span><span class="dv">0</span>,
         sex <span class="op">!=</span><span class="st"> "both"</span>,
         age_group_id <span class="op">%in%</span><span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="dv">17</span>,
         indicator_id <span class="op">==</span><span class="st"> </span>4L) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">left_join</span>(<span class="kw"><a href="../reference/get_age_groups.html">get_age_groups</a></span>()) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">age_group =</span> <span class="kw">fct_reorder</span>(age_group_label, age_group_id)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(age_group, mean, <span class="dt">ymin =</span> lower, <span class="dt">ymax =</span> upper, <span class="dt">fill =</span> sex)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_col</span>(<span class="dt">position =</span> <span class="st">"dodge"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_linerange</span>(<span class="dt">position =</span> <span class="kw">position_dodge</span>(<span class="fl">0.8</span>)) <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_fill_brewer</span>(<span class="dt">palette =</span> <span class="st">"Set1"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">labels =</span> scales<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/scales/man/number_format.html">percent_format</a></span>(<span class="dv">1</span>)) <span class="op">+</span>
<span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>area_name) <span class="op">+</span>
<span class="st">  </span><span class="kw">theme</span>(<span class="dt">axis.text.x =</span> <span class="kw">element_text</span>(<span class="dt">angle =</span> <span class="dv">90</span>, <span class="dt">hjust =</span> <span class="fl">1.0</span>, <span class="dt">vjust =</span> <span class="fl">0.5</span>))
<span class="co">#&gt; Joining, by = c("age_group_id", "age_group_label")</span></code></pre></div>
<div class="figure">
<img src="figure/unnamed-chunk-19-1.png" alt="plot of chunk unnamed-chunk-19"><p class="caption">plot of chunk unnamed-chunk-19</p>
</div>
<p>ART coverage by age/sex and region</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">indicators <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(area_level <span class="op">==</span><span class="st"> </span><span class="dv">1</span>,
         sex <span class="op">!=</span><span class="st"> "both"</span>,
         age_group_id <span class="op">%in%</span><span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="dv">17</span>,
         indicator_id <span class="op">==</span><span class="st"> </span>4L) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">left_join</span>(<span class="kw"><a href="../reference/get_age_groups.html">get_age_groups</a></span>()) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">age_group =</span> <span class="kw">fct_reorder</span>(age_group_label, age_group_id)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(age_group, mean, <span class="dt">ymin =</span> lower, <span class="dt">ymax =</span> upper, <span class="dt">fill =</span> sex)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_col</span>(<span class="dt">position =</span> <span class="st">"dodge"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_linerange</span>(<span class="dt">position =</span> <span class="kw">position_dodge</span>(<span class="fl">0.8</span>)) <span class="op">+</span>
<span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>area_name) <span class="op">+</span>
<span class="st">  </span><span class="kw">theme</span>(<span class="dt">axis.text.x =</span> <span class="kw">element_text</span>(<span class="dt">angle =</span> <span class="dv">90</span>, <span class="dt">hjust =</span> <span class="fl">1.0</span>, <span class="dt">vjust =</span> <span class="fl">0.5</span>))
<span class="co">#&gt; Joining, by = c("age_group_id", "age_group_label")</span></code></pre></div>
<div class="figure">
<img src="figure/unnamed-chunk-20-1.png" alt="plot of chunk unnamed-chunk-20"><p class="caption">plot of chunk unnamed-chunk-20</p>
</div>
<p>Bubble plot prevalence and PLHIV</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">indicators <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(age_group_id <span class="op">==</span><span class="st"> </span><span class="dv">19</span>,
         area_level <span class="op">==</span><span class="st"> </span><span class="dv">4</span>,
         indicator_id <span class="op">%in%</span><span class="st"> </span><span class="dv">2</span><span class="op">:</span><span class="dv">3</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(sex, center_x, center_y, indicator_label, mean) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">spread</span>(indicator_label, mean) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">ggplot</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_sf</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(center_x, center_y, <span class="dt">colour =</span> <span class="st">`</span><span class="dt">HIV Prevalence</span><span class="st">`</span>, <span class="dt">size =</span> PLHIV)) <span class="op">+</span>
<span class="st">  </span>viridis<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/viridis/man/scale_viridis.html">scale_color_viridis</a></span>(<span class="dt">labels =</span> scales<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/scales/man/number_format.html">percent_format</a></span>()) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="../reference/th_map.html">th_map</a></span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>sex)</code></pre></div>
<div class="figure">
<img src="figure/unnamed-chunk-21-1.png" alt="plot of chunk unnamed-chunk-21"><p class="caption">plot of chunk unnamed-chunk-21</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#prepare-webtool-geojson-input">0. Prepare webtool GeoJSON input</a></li>
      <li><a href="#upload-data-inputs">1. (Up)Load data inputs</a></li>
      <li><a href="#choose-model-areas-and-time-points">2. Choose model areas and time points</a></li>
      <li><a href="#review-input-data">3. Review input data</a></li>
      <li><a href="#prepare-model-inputs">4. Prepare model inputs</a></li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Jeff Eaton.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
